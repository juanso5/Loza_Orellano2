"use client";import { useState, useEffect } from 'react';export default function DetalleEspecieModal({ fondo, especie, onClose }) {  const [movimientos, setMovimientos] = useState([]);  const [loading, setLoading] = useState(true);  const [error, setError] = useState(null);  useEffect(() => {    if (!fondo?.id_fondo || !especie?.tipo_especie_id) return;    setLoading(true);    setError(null);    fetch(`/api/movimiento?fondo_id=${fondo.id_fondo}&tipo_especie_id=${especie.tipo_especie_id}`)      .then(r => {        if (!r.ok) throw new Error('Error al cargar movimientos');        return r.json();      })      .then(data => {        const movs = Array.isArray(data.data) ? data.data : [];        setMovimientos(movs);      })      .catch(err => {        setError(err.message);      })      .finally(() => setLoading(false));  }, [fondo?.id_fondo, especie?.tipo_especie_id]);  const handleOverlayClick = (e) => {    if (e.target === e.currentTarget) {      onClose?.();    }  };  const nombreFondo = fondo?.nombre || fondo?.tipo_cartera?.descripcion || `Fondo #${fondo?.id_fondo}`;  // Calcular totales  const totales = movimientos.reduce((acc, m) => {    const monto = (m.nominal || 0) * (m.precio_usd || 0);    if (m.tipo_mov === 'compra') {      acc.totalCompras += m.nominal || 0;      acc.montoCompras += monto;    } else {      acc.totalVentas += m.nominal || 0;      acc.montoVentas += monto;    }    return acc;  }, { totalCompras: 0, totalVentas: 0, montoCompras: 0, montoVentas: 0 });  return (    <div       className="modal"       style={{ display: 'flex' }}      onClick={handleOverlayClick}    >      <div className="modal-dialog" style={{ maxWidth: '900px', width: '90%' }}>        <header className="modal-header" style={{           display: 'flex',           justifyContent: 'space-between',           alignItems: 'center',          borderBottom: '2px solid #e5e7eb'        }}>          <div>            <h2 style={{ margin: 0, fontSize: '1.25rem', fontWeight: '700', color: '#111827' }}>              ðŸ“ˆ {especie?.especie_nombre || 'Especie'}            </h2>            <p style={{ margin: '0.25rem 0 0', fontSize: '0.875rem', color: '#6b7280' }}>              {nombreFondo}            </p>          </div>          <button             onClick={onClose}            className="modal-close"            style={{              background: 'none',              border: 'none',              fontSize: '1.5rem',              cursor: 'pointer',              color: '#6b7280',              padding: '0.25rem 0.5rem'            }}          >            &times;          </button>        </header>        <div className="modal-body" style={{ padding: '1.5rem' }}>          {loading && (            <div style={{               padding: '3rem',               textAlign: 'center',               color: '#6b7280',              display: 'flex',              flexDirection: 'column',              alignItems: 'center',              gap: '1rem'            }}>              <div style={{                width: '40px',                height: '40px',                border: '3px solid #e5e7eb',                borderTopColor: '#3b82f6',                borderRadius: '50%',                animation: 'spin 1s linear infinite'              }}></div>              <p>Cargando historial...</p>            </div>          )}          {error && (            <div style={{               padding: '1rem',               background: '#fee2e2',               border: '1px solid #ef4444',              borderRadius: '8px',              color: '#991b1b',              marginBottom: '1rem'            }}>              <strong>Error:</strong> {error}            </div>          )}          {!loading && !error && (            <>              {/* Resumen de la especie */}              <div style={{                 padding: '1.5rem',                 background: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',                 borderRadius: '12px',                marginBottom: '1.5rem',                border: '1px solid #bfdbfe'              }}>                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '1rem' }}>                  <div>                    <div style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '0.25rem', textTransform: 'uppercase', fontWeight: '600' }}>                      Cantidad Total                    </div>                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#1e40af' }}>                      {especie?.cantidad_actual?.toLocaleString('es-AR') || 0}                    </div>                    <div style={{ fontSize: '0.75rem', color: '#6b7280', marginTop: '0.125rem' }}>                      unidades                    </div>                  </div>                  <div>                    <div style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '0.25rem', textTransform: 'uppercase', fontWeight: '600' }}>                      Precio Actual                    </div>                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#1e40af' }}>                      {especie?.precio_actual                         ? `$${especie.precio_actual.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`                        : <span style={{ fontSize: '1rem', color: '#9ca3af' }}>Sin precio</span>                      }                    </div>                    <div style={{ fontSize: '0.75rem', color: '#6b7280', marginTop: '0.125rem' }}>                      {especie?.fecha_precio ? new Date(especie.fecha_precio).toLocaleDateString('es-AR') : 'N/A'}                    </div>                  </div>                  <div>                    <div style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '0.25rem', textTransform: 'uppercase', fontWeight: '600' }}>                      Valor Total                    </div>                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#1e40af' }}>                      ${especie?.valor_total_usd?.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) || '0.00'}                    </div>                    <div style={{ fontSize: '0.75rem', color: '#6b7280', marginTop: '0.125rem' }}>                      USD                    </div>                  </div>                </div>                <div style={{ marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid #bfdbfe' }}>                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>                    <div>                      <span style={{ fontSize: '0.875rem', color: '#6b7280' }}>                        Precio Promedio Compra:                      </span>                      <span style={{ fontSize: '0.875rem', fontWeight: '600', color: '#1e40af', marginLeft: '0.5rem' }}>                        {especie?.precio_promedio_compra                           ? `$${especie.precio_promedio_compra.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`                          : 'N/A'                        }                      </span>                    </div>                    <div style={{                       fontSize: '1rem',                       fontWeight: '700',                      color: (especie?.ganancia_perdida_usd || 0) >= 0 ? '#15803d' : '#991b1b'                    }}>                      {(especie?.ganancia_perdida_usd || 0) >= 0 ? '+' : ''}                      ${Math.abs(especie?.ganancia_perdida_usd || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}                      <span style={{ fontSize: '0.875rem', marginLeft: '0.5rem', opacity: 0.8 }}>                        ({(especie?.rendimiento_porcentaje || 0) >= 0 ? '+' : ''}{especie?.rendimiento_porcentaje?.toFixed(2) || '0.00'}%)                      </span>                    </div>                  </div>                </div>              </div>              {/* EstadÃ­sticas de movimientos */}              <div style={{                 display: 'grid',                 gridTemplateColumns: '1fr 1fr',                 gap: '1rem',                 marginBottom: '1.5rem'               }}>                <div style={{                   padding: '1rem',                   background: '#f0fdf4',                   borderRadius: '8px',                  border: '1px solid #bbf7d0'                }}>                  <div style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '0.5rem', fontWeight: '600' }}>                    â–² COMPRAS                  </div>                  <div style={{ fontSize: '1.25rem', fontWeight: '700', color: '#15803d' }}>                    {totales.totalCompras.toLocaleString('es-AR')} unidades                  </div>                  <div style={{ fontSize: '0.875rem', color: '#6b7280', marginTop: '0.25rem' }}>                    ${totales.montoCompras.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USD                  </div>                </div>                <div style={{                   padding: '1rem',                   background: '#fef2f2',                   borderRadius: '8px',                  border: '1px solid #fecaca'                }}>                  <div style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '0.5rem', fontWeight: '600' }}>                    â–¼ VENTAS                  </div>                  <div style={{ fontSize: '1.25rem', fontWeight: '700', color: '#991b1b' }}>                    {totales.totalVentas.toLocaleString('es-AR')} unidades                  </div>                  <div style={{ fontSize: '0.875rem', color: '#6b7280', marginTop: '0.25rem' }}>                    ${totales.montoVentas.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USD                  </div>                </div>              </div>              {/* Historial de movimientos */}              <h3 style={{ fontSize: '1rem', fontWeight: '600', marginBottom: '1rem', color: '#111827', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>                ðŸ“œ Historial de Movimientos              </h3>              {movimientos.length > 0 ? (                <div style={{                   background: '#fff',                  border: '1px solid #e5e7eb',                  borderRadius: '12px',                  overflow: 'hidden'                }}>                  <table style={{ width: '100%', borderCollapse: 'collapse' }}>                    <thead>                      <tr style={{ background: '#f9fafb', borderBottom: '2px solid #e5e7eb' }}>                        <th style={{ padding: '0.75rem 1rem', textAlign: 'left', fontSize: '0.75rem', color: '#6b7280', fontWeight: '600', textTransform: 'uppercase' }}>                          Fecha                        </th>                        <th style={{ padding: '0.75rem 1rem', textAlign: 'center', fontSize: '0.75rem', color: '#6b7280', fontWeight: '600', textTransform: 'uppercase' }}>                          Tipo                        </th>                        <th style={{ padding: '0.75rem 1rem', textAlign: 'right', fontSize: '0.75rem', color: '#6b7280', fontWeight: '600', textTransform: 'uppercase' }}>                          Cantidad                        </th>                        <th style={{ padding: '0.75rem 1rem', textAlign: 'right', fontSize: '0.75rem', color: '#6b7280', fontWeight: '600', textTransform: 'uppercase' }}>                          Precio USD                        </th>                        <th style={{ padding: '0.75rem 1rem', textAlign: 'right', fontSize: '0.75rem', color: '#6b7280', fontWeight: '600', textTransform: 'uppercase' }}>                          Total USD                        </th>                      </tr>                    </thead>                    <tbody>                      {movimientos.map((m) => (                        <tr key={m.id_movimiento} style={{ borderBottom: '1px solid #f3f4f6' }}>                          <td style={{ padding: '0.875rem 1rem', color: '#6b7280', fontSize: '0.875rem' }}>                            {new Date(m.fecha_alta).toLocaleDateString('es-AR', {                               year: 'numeric',                               month: 'short',                               day: 'numeric'                             })}                          </td>                          <td style={{ padding: '0.875rem 1rem', textAlign: 'center' }}>                            <span style={{                              padding: '4px 12px',                              borderRadius: '6px',                              fontSize: '0.75rem',                              fontWeight: '600',                              background: m.tipo_mov === 'compra' ? '#d1fae5' : '#fee2e2',                              color: m.tipo_mov === 'compra' ? '#065f46' : '#991b1b',                              display: 'inline-flex',                              alignItems: 'center',                              gap: '0.25rem'                            }}>                              {m.tipo_mov === 'compra' ? 'â–²' : 'â–¼'} {m.tipo_mov === 'compra' ? 'Compra' : 'Venta'}                            </span>                          </td>                          <td style={{ padding: '0.875rem 1rem', textAlign: 'right', fontWeight: '600', color: '#111827' }}>                            {m.nominal?.toLocaleString('es-AR') || 0}                          </td>                          <td style={{ padding: '0.875rem 1rem', textAlign: 'right', color: '#6b7280' }}>                            {m.precio_usd                               ? `$${m.precio_usd.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`                              : <span style={{ color: '#9ca3af' }}>â€”</span>                            }                          </td>                          <td style={{ padding: '0.875rem 1rem', textAlign: 'right', fontWeight: '600', color: '#111827' }}>                            ${((m.nominal || 0) * (m.precio_usd || 0)).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}                          </td>                        </tr>                      ))}                    </tbody>                  </table>                </div>              ) : (                <div style={{                   padding: '2rem',                   textAlign: 'center',                   color: '#6b7280',                  background: '#f9fafb',                  borderRadius: '8px',                  border: '1px dashed #d1d5db'                }}>                  No hay movimientos registrados para esta especie                </div>              )}            </>          )}        </div>        <footer className="modal-footer" style={{           display: 'flex',           justifyContent: 'flex-end',           gap: '0.75rem',          padding: '1rem 1.5rem',          borderTop: '1px solid #e5e7eb',          background: '#f9fafb'        }}>          <button             onClick={onClose}             className="btn"            style={{              padding: '0.5rem 1.5rem',              borderRadius: '8px',              border: '1px solid #d1d5db',              background: '#fff',              color: '#374151',              fontWeight: '500',              cursor: 'pointer',              transition: 'all 0.15s'            }}            onMouseEnter={(e) => e.currentTarget.style.background = '#f3f4f6'}            onMouseLeave={(e) => e.currentTarget.style.background = '#fff'}          >            Cerrar          </button>        </footer>      </div>      <style jsx>{`        @keyframes spin {          to { transform: rotate(360deg); }        }      `}</style>    </div>  );}